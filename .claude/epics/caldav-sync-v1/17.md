---
name: Implement diff engine, changeset application, and sync integration
status: open
created: 2026-02-12T00:23:37Z
updated: 2026-02-12T00:28:04Z
github: https://github.com/josecoelho/obsidian-tasks-caldav/issues/17
depends_on: [15]
parallel: false
conflicts_with: [14]
---

# Task: Implement diff engine, changeset application, and sync integration

## Description
Implement the core `diff()` pure function and integrate it into the sync engine, replacing the current MVP implementation. This is part 2 of the sync engine rewrite (GitHub #6, ADR-005).

The diff function performs three-way comparison: left (Obsidian), right (CalDAV), baseline (last sync snapshot). It produces a changeset of creates, updates, and deletes for each side. Conflict strategy is a parameter, not hardcoded.

## Acceptance Criteria
- [ ] `diff(left: CommonTask[], right: CommonTask[], baseline: CommonTask[]): Changeset` implemented as a pure function
- [ ] Changeset contains: `leftCreates`, `leftUpdates`, `leftDeletes`, `rightCreates`, `rightUpdates`, `rightDeletes`, `conflicts`
- [ ] Delete detection: task in baseline but missing from one side = deleted on that side
- [ ] Conflict detection: task modified on both sides since baseline
- [ ] Conflict strategy parameter: "caldav-wins", "obsidian-wins", "manual"
- [ ] Baseline snapshot saved after each successful sync
- [ ] New `SyncEngine` class replaces old `syncEngine.ts`, wired into `main.ts`
- [ ] Existing sync behavior preserved (push/pull both work)
- [ ] Comprehensive unit tests for diff(): creates, updates, deletes, conflicts, no-ops, mixed scenarios

## Technical Details
- **New files:**
  - `src/sync/diff.ts` — pure `diff()` function
  - `src/sync/diff.test.ts` — comprehensive tests
  - `src/sync/syncEngineV2.ts` — new sync engine using adapters + diff
- **Modified files:**
  - `main.ts` — swap old SyncEngine for new one
  - `src/storage/syncStorage.ts` — add baseline snapshot storage
- **Delete old:**
  - `src/sync/syncEngine.ts` — replaced by syncEngineV2
  - `src/sync/syncEngine.test.ts` — replaced by new tests
- **Baseline storage:** Save `CommonTask[]` snapshot as `.caldav-sync/baseline.json` after each sync
- **Matching logic:** Tasks matched by `uid` field (obsidian task ID maps to CalDAV UID via mapping)

## Dependencies
- [ ] Task 002 (CommonTask + adapters) — provides types and normalization layer

## Effort Estimate
- Size: L
- Hours: 10-16
- Parallel: false (depends on 002)
